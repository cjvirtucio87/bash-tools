#!/usr/bin/env bash

set -e

ROOT_DIR="$(dirname "$(readlink --canonicalize "$0")")"
readonly DEV_CONTAINER_NAME='vim-devc'
readonly ROOT_DIR

function build_vim_overlay {
  local tag="$1"
  local no_version_tag
  no_version_tag="$(echo -n "${tag}" | cut -d ':' -f1)"
  local tag_version
  tag_version="$(echo -n "${tag}" | cut -d ':' -f2)"

  local vim_devc_tag="${no_version_tag}-vim-devc:${tag_version}"
  docker build --tag "${vim_devc_tag}" --file - "${ROOT_DIR}"/../lib/vim_devc/context <<EOF
FROM ${tag}

USER 0

RUN set -e; \
    dnf install --assumeyes gcc make ncurses ncurses-devel; \
    curl \
      --location \
      --output vim-src.zip \
      https://github.com/vim/vim/archive/refs/heads/master.zip; \
    mkdir vim-src; \
    unzip -d vim-src vim-src.zip; \
    cd vim-src/vim-master; \
    make; \
    make install; \
    vim --version; \
    : ;

USER "\${REMOTE_USER}"
EOF

  echo -n "${vim_devc_tag}"
}

function devcontainer_json {
  local local_workspace_folder="$1"
  local key="$2"

  local json_path="${local_workspace_folder}/.devcontainer/devcontainer.json"
  if [[ ! -f "${json_path}" ]]; then
    >&2 echo "missing devcontainer.json file in local workspace folder [${local_workspace_folder}]"
    return 1
  fi

  clconf --ignore-env --yaml "${json_path}" getv "${key}"
}

function main {
  local local_workspace_folder="${1:-"${PWD}"}"
  local_workspace_folder="$(readlink --canonicalize "${local_workspace_folder}")"

  local tag
  tag="$(devcontainer_json "${local_workspace_folder}" 'image')"

  local vim_devc_tag
  vim_devc_tag="$(build_vim_overlay "${tag}")"

  local workspace_name
  workspace_name="$(basename "${local_workspace_folder}")"

  local container_user
  if ! container_user="$(devcontainer_json "${local_workspace_folder}" 'containerUser')"; then
    container_user=root
  fi

  local remote_user
  if ! remote_user="$(devcontainer_json "${local_workspace_folder}" 'remoteUser')"; then
    remote_user="${container_user}"
  fi

  local container_workspace_folder="/workspaces/${workspace_name}"
  docker run \
    --rm \
    --interactive \
    --tty \
    --env "AD_HOC=1" \
    --mount "type=bind,src=${local_workspace_folder},dst=${container_workspace_folder}" \
    --mount "type=bind,src=${HOME}/.vimrc,dst=/home/dev/.vimrc" \
    --mount "type=bind,src=${HOME}/.vim,dst=/home/${remote_user}/.vim" \
    --workdir "${container_workspace_folder}" \
    --user "$(id --user):$(id --group)" \
    --name "${DEV_CONTAINER_NAME}" \
    "${vim_devc_tag}"
}

main "$@"
